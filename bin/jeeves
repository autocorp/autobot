#!/usr/bin/env python

import getopt
import sys
import os
import subprocess
from subprocess import call
import re

options, remainder = getopt.getopt(sys.argv[1:], 'cwrh', ['check', 'walkthrough', 'run', 'help', ])


class colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def get_version(command):
    command_result = os.popen(command).read()
    m = re.search('(\d+\.)?(\d+\.)?(\*|\d+)', command_result)
    return m.group(0)


def version_check(software, try_text):
    software_version = get_version("%s --version" % software)
    if(software_version <= 0):
        print (colors.FAIL + "[FAIL] %s v%s :: try `%s`" % (software, software_version, try_text) + colors.ENDC)
    else:
        print (colors.OKGREEN + "[ok] %s v%s" % (software, software_version) + colors.ENDC)


def env_check(env_vars):

    # find the longest string (first loop)
    longest=0
    for key, value in env_vars.iteritems():

        env_value = os.environ.get(key)

        if(env_value):
            envlen=len(env_value)
        else:
            envlen = 16 # if we don't have an env value, we'll print `Variable not set`

        variblelen=len(key)+envlen

        if variblelen > longest:
            longest = variblelen

    # print the values (second loop)
    for key, value in env_vars.iteritems():

        env_value = os.environ.get(key)

        if (env_value is None):
            env_value = 'Variable not set'
            envlen = 16 # if we don't have an env value, we'll print `Variable not set`
        else:
            envlen=len(env_value)

        variblelen=longest-(len(key)+envlen)

        padding_string=" "*(variblelen)

        if (os.environ.get(key) is None) or (len(env_value)==0):
            start_color=colors.FAIL
        else:
            start_color=colors.OKGREEN

            # if it's a password, lets not print all of it
            if "PASSWORD" in key:
                if (len(env_value)>3):
                    env_value = '*'*(len(env_value)-2) + env_value[len(env_value)-2:]
                else:
                    env_value = '*'*len(env_value)

        print "Your ENV %s%s=%s%s %s:: Try something like this `export %s=%s`" % (start_color, key, env_value, colors.ENDC, padding_string, key, value)

    print


def check_requirments():

    print
    print colors.HEADER + 'Checking for software dependencies' + colors.ENDC
    version_check("ansible", "brew install ansible")
    version_check("git", "brew install git")
    version_check("vboxmanage", "https://www.virtualbox.org/wiki/Downloads")
    version_check("docker", "curl -L https://get.docker.com/builds/Darwin/x86_64/docker-latest > /usr/local/bin/docker'")
    version_check("docker-machine", "sudo wget -O /usr/local/bin/docker-machine https://github.com/docker/machine/releases/download/v0.1.0/docker-machine_darwin-amd64; chmod +x docker-machine")
    version_check("docker-compose", "curl -L https://github.com/docker/compose/releases/download/1.1.0/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose; chmod +x /usr/local/bin/docker-compose")

    print
    print colors.HEADER + 'Checking your ~/.docker/ file for autobot machine keys' + colors.ENDC
    command = 'ls -la ~/.docker/machine/machines/autobot/'
    command_result = os.popen(command).read()
    print command_result

    print
    print colors.HEADER + 'Checking your ENV variables (place these somewhere like ~/.bash_profile so they persist)' + colors.ENDC

    env_vars = {
        'PWD'                    : '~/autobot',
        'MACHINE_STORAGE_PATH'   : '$PWD/.docker',
        'CONFLUENCE_USERNAME'    : 'your_username',
        'CONFLUENCE_PASSWORD'    : 'your_password',
        'HUBOT_HIPCHAT_JID'      : 'hubot_username',
        'HUBOT_HIPCHAT_PASSWORD' : 'hubot_password'
    }
    
    env_check(env_vars)    

    print colors.HEADER + 'Checking what docker machines you have access to' + colors.ENDC
    print '`docker-machine ls`'
    command = 'docker-machine ls'
    command_result = os.popen(command).read()
    print command_result

    print colors.HEADER + 'Checking containers in dev' + colors.ENDC
    print '`eval "$(docker-machine env dev)"; docker ps`'
    command = 'eval "$(docker-machine env dev)"; docker ps'
    command_result = os.popen(command).read()
    print command_result

def walkthrough():

    print

    print colors.HEADER + 'Create a docker machine on Amazon EC2' + colors.ENDC
    print 'ansible-playbook -i hosts site.yml  # specify --ask-vault-pass if your groups_vars/all is encrypted'
    print

    print colors.HEADER + 'Create docker containers on your host' + colors.ENDC
    print 'docker-compose up'
    print

    print colors.HEADER + 'Spin up a hubot container...' + colors.ENDC
    print colors.OKBLUE + 'Pass confluence credentials.' + colors.ENDC
    print 'docker-compose build hubot && docker run -it --rm \\' 
    print '-e CONFLUENCE_USERNAME=$CONFLUENCE_USERNAME -e CONFLUENCE_PASSWORD=$CONFLUENCE_PASSWORD'
    print

    print colors.HEADER + '...Optional: Link Containers' + colors.ENDC
    print colors.OKBLUE + 'Linking to the existing redis container.' + colors.ENDC
    print colors.OKBLUE + 'The hubot container is not given a name so it will not conflict with the existing hubot container.' + colors.ENDC
    print '--link autobot_redis_1:redis autobot_hubot:latest'
    print

    print colors.HEADER + '...Optional: Hipchat Connector (and Shell Adapter)' + colors.ENDC
    print colors.OKBLUE + 'Using hubot vars and connector (-a hipchat).' + colors.ENDC
    print colors.OKBLUE + 'The "Shell" adapter (hubot) can be used to test your change on the commandline' + colors.ENDC
    print '-e HUBOT_HIPCHAT_JID=$HUBOT_HIPCHAT_JID -e HUBOT_HIPCHAT_PASSWORD=$HUBOT_HIPCHAT_PASSWORD \\'
    print ' hubot -a hipchat'
    print

    print colors.HEADER + 'All together' + colors.ENDC
    print colors.OKBLUE + 'Using all the option extras.' + colors.ENDC
    print colors.OKBLUE + '`hubot` dumps you into a hubot-shell after spining up the containers' + colors.ENDC
    print colors.OKBLUE + '`-a hipchat` will connect directly to a hipchat server' + colors.ENDC
    print 'docker-compose build hubot && docker run -it --rm \\' 
    print '-e CONFLUENCE_USERNAME=$CONFLUENCE_USERNAME -e CONFLUENCE_PASSWORD=$CONFLUENCE_PASSWORD \\'
    print '-e HUBOT_HIPCHAT_JID=$HUBOT_HIPCHAT_JID -e HUBOT_HIPCHAT_PASSWORD=$HUBOT_HIPCHAT_PASSWORD \\'
    print '--link autobot_redis_1:redis autobot_hubot:latest hubot -a hipchat'
    print

    print colors.HEADER + 'What it looks like when it works' + colors.ENDC
    print colors.OKGREEN + '$ docker-compose build hubot && docker run ... hubot' + colors.ENDC
    print colors.OKBLUE + 'Building hubot...' + colors.ENDC
    print colors.OKBLUE + 'Step 0 : FROM ubuntu:trusty' + colors.ENDC
    print colors.OKBLUE + 'Step 1 : MAINTAINER Autocorp <https://github.com/autocorp>' + colors.ENDC
    print colors.OKBLUE + '...' + colors.ENDC
    print colors.OKBLUE + 'Successfully built 4be767a4a3a8' + colors.ENDC
    print colors.OKGREEN + 'Hubot> @hubot what is your opinion on badgers' + colors.ENDC
    print colors.OKBLUE + 'Badgers? BADGERS? WE DON\'T NEED NO STINKIN BADGERS' + colors.ENDC
    print

def run():

    if len(sys.argv) < 3:
        print colors.FAIL + 'why you no pass run param. Try `local`.' + colors.ENDC

    elif (sys.argv[2]=='local'):
        print
        print colors.HEADER + '###########################' + colors.ENDC
        print colors.HEADER + '# Local autobot development' + colors.ENDC
        print colors.HEADER + '###########################' + colors.ENDC
        print
        print colors.OKBLUE + '# Create a VM for local development.' + colors.ENDC
        print colors.OKBLUE + '# Eval the docker env vars: Useful as your docker-* commands will target the autobot host.' + colors.ENDC
        print colors.OKBLUE + '# Build the Hubot container and run the Hubot shell.' + colors.ENDC
        print 'docker-machine create -d virtualbox dev'
        print 'eval "$(docker-machine env dev)"'
        print 'docker-compose build hubot && docker run -it --rm autobot_hubot:latest hubot'
        
        print
        print colors.HEADER + '# The Hubot shell:' + colors.ENDC
        print colors.OKBLUE + '# Hubot> @hubot badgers' + colors.ENDC
        print colors.OKBLUE + '# Badgers? BADGERS? WE DON\'T NEED NO STINKIN BADGERS' + colors.ENDC
        print

    else:
        print colors.FAIL + 'why you no pass run param. Try `local`.' + colors.ENDC

def help():

        print colors.HEADER + '--------------------------------------------------------------------------' + colors.ENDC
        print colors.HEADER + 'Hi, I\'m Jeeves. I\'m here to make sure everything is okay with autobot. *_*' + colors.ENDC
        print colors.HEADER + '--------------------------------------------------------------------------' + colors.ENDC

        print 'I can be quite helpful if you know how to ask.'
        print

        print colors.OKBLUE + '    -c --check' + colors.ENDC 
        print '        Check that you have the required software, and help you install it.'
        print '        Check for env vars.'
        print '        Check what docker machines you have access to.'
        print

        print colors.OKBLUE + '    -h --help' + colors.ENDC 
        print '        Show this awesome help screen, but then again you alredy knew'
        print '        that -h does this, didn\'t you?'
        print

        print colors.OKBLUE + '    -r --run' + colors.ENDC 
        print '        Let me show you what commands to run, to get everyday tasks complete.'
        print
        print colors.OKBLUE + '        jeeves -r local' + colors.ENDC 
        print '            Create a VM for local development'
        print

        print colors.OKBLUE + '    -w --walkthrough' + colors.ENDC 
        print '        A walkthrough of useful commands for controlling autobot.'
        print

if __name__ == '__main__':

    # set vars
    # act on incoming params
    for opt, arg in options:
        if opt in ['-c', '--check']:
            check_requirments()
        elif opt in ['-w', '--walkthrough']:
            walkthrough()
        elif opt in ['-r', '--run']:
            run()
        elif opt in ['-h', '--help']:
            help()

    # if no args passed, show help
    if not sys.argv[1:]:
        help()
